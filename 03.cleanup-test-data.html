<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .warning {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .danger {
            background-color: #dc3545;
        }
        .danger:hover {
            background-color: #c82333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #f8f9fa;
        }
        .license-row {
            cursor: pointer;
        }
        .license-row:hover {
            background-color: #f8f9fa;
        }
        .selected {
            background-color: #e3f2fd;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§¹ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬</h1>
        
        <div class="section">
            <h3>ğŸ“Š í˜„ì¬ ë°ì´í„° í˜„í™©</h3>
            <button onclick="loadCurrentData()">ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
            <div id="statsResult"></div>
        </div>

        <div class="section">
            <h3>ğŸ“‹ ë¼ì´ì„¼ìŠ¤ ëª©ë¡</h3>
            <button onclick="selectAllTestLicenses()">í…ŒìŠ¤íŠ¸ ë¼ì´ì„¼ìŠ¤ ì „ì²´ ì„ íƒ</button>
            <button onclick="clearSelection()">ì„ íƒ í•´ì œ</button>
            <button onclick="deleteSelected()" class="danger">ì„ íƒëœ ë¼ì´ì„¼ìŠ¤ ì‚­ì œ</button>
            <div id="licenseTable"></div>
        </div>

        <div class="section warning">
            <h3>âš ï¸ ìœ„í—˜í•œ ì‘ì—…</h3>
            <p><strong>ì£¼ì˜:</strong> ì•„ë˜ ì‘ì—…ë“¤ì€ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤!</p>
            <button onclick="deleteAllTestData()" class="danger">ëª¨ë“  í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ</button>
            <button onclick="deleteAllLicenses()" class="danger">ëª¨ë“  ë¼ì´ì„¼ìŠ¤ ì‚­ì œ</button>
        </div>

        <div class="section">
            <h3>ğŸ“‹ ì‹¤í–‰ ë¡œê·¸</h3>
            <button onclick="clearLog()">ë¡œê·¸ í´ë¦¬ì–´</button>
            <div id="logOutput" class="log"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <script>
        // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        const SUPABASE_URL = 'https://qwbhuusjpnpfwwrzpnfx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3Ymh1dXNqcG5wZnd3cnpwbmZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0OTkxNTgsImV4cCI6MjA2ODA3NTE1OH0.G2k1yy6bbnpyi2F6U7cPC1Y6LtBn2nCvfuIUHPXxb9s';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let allLicenses = [];
        let selectedLicenses = new Set();

        function log(message) {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            logOutput.textContent += `[${timestamp}] ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logOutput').textContent = '';
        }

        function showResult(elementId, success, message) {
            const element = document.getElementById(elementId);
            element.className = success ? 'success' : 'error';
            element.innerHTML = message;
        }

        // í˜„ì¬ ë°ì´í„° í˜„í™© ë¡œë“œ
        async function loadCurrentData() {
            try {
                log('ë°ì´í„° í˜„í™© ì¡°íšŒ ì‹œì‘...');

                // ë¼ì´ì„¼ìŠ¤ ë°ì´í„° ì¡°íšŒ
                const { data: licenses, error: licenseError } = await supabase
                    .from('licenses')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (licenseError) throw licenseError;

                // ê²°ì œ ë°ì´í„° ì¡°íšŒ
                const { data: payments, error: paymentError } = await supabase
                    .from('payments')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (paymentError) throw paymentError;

                // ì‚¬ìš©ì í™œì„±í™” ë°ì´í„° ì¡°íšŒ
                const { data: activations, error: activationError } = await supabase
                    .from('user_activations')
                    .select('*')
                    .order('activated_at', { ascending: false });

                if (activationError) throw activationError;

                // í†µê³„ ê³„ì‚°
                const stats = {
                    totalLicenses: licenses.length,
                    activeLicenses: licenses.filter(l => l.status === 'active').length,
                    testLicenses: licenses.filter(l => l.license_key.startsWith('TEST_') || l.payment_provider === 'test').length,
                    paypalLicenses: licenses.filter(l => l.payment_provider === 'paypal').length,
                    tossLicenses: licenses.filter(l => l.payment_provider === 'toss').length,
                    totalPayments: payments.length,
                    totalActivations: activations.length,
                    uniqueUsers: new Set(licenses.map(l => l.user_email)).size
                };

                allLicenses = licenses;

                showResult('statsResult', true, `
                    ğŸ“Š <strong>ë°ì´í„° í˜„í™©</strong><br>
                    ğŸ”‘ ì´ ë¼ì´ì„¼ìŠ¤: ${stats.totalLicenses}ê°œ<br>
                    âœ… í™œì„± ë¼ì´ì„¼ìŠ¤: ${stats.activeLicenses}ê°œ<br>
                    ğŸ§ª í…ŒìŠ¤íŠ¸ ë¼ì´ì„¼ìŠ¤: ${stats.testLicenses}ê°œ<br>
                    ğŸ’³ PayPal: ${stats.paypalLicenses}ê°œ, Toss: ${stats.tossLicenses}ê°œ<br>
                    ğŸ’° ì´ ê²°ì œ ê¸°ë¡: ${stats.totalPayments}ê°œ<br>
                    ğŸ‘¥ ê³ ìœ  ì‚¬ìš©ì: ${stats.uniqueUsers}ëª…<br>
                    ğŸ“± ì´ í™œì„±í™” ê¸°ë¡: ${stats.totalActivations}ê°œ
                `);

                // ë¼ì´ì„¼ìŠ¤ í…Œì´ë¸” ì—…ë°ì´íŠ¸
                updateLicenseTable();

                log(`âœ… ë°ì´í„° í˜„í™© ë¡œë“œ ì™„ë£Œ: ë¼ì´ì„¼ìŠ¤ ${licenses.length}ê°œ`);

            } catch (error) {
                showResult('statsResult', false, `âŒ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`);
                log(`âŒ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // ë¼ì´ì„¼ìŠ¤ í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateLicenseTable() {
            const tableContainer = document.getElementById('licenseTable');
            
            if (allLicenses.length === 0) {
                tableContainer.innerHTML = '<p>ë¼ì´ì„¼ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ì„ íƒ</th>
                            <th>ë¼ì´ì„¼ìŠ¤ í‚¤</th>
                            <th>ì‚¬ìš©ì</th>
                            <th>ê²°ì œ ì œê³µì</th>
                            <th>ìƒíƒœ</th>
                            <th>ìƒì„±ì¼</th>
                            <th>ë§Œë£Œì¼</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allLicenses.map(license => `
                            <tr class="license-row ${selectedLicenses.has(license.id) ? 'selected' : ''}" 
                                onclick="toggleLicenseSelection('${license.id}')">
                                <td>
                                    <input type="checkbox" 
                                           ${selectedLicenses.has(license.id) ? 'checked' : ''}
                                           onchange="event.stopPropagation(); toggleLicenseSelection('${license.id}')">
                                </td>
                                <td>${license.license_key}</td>
                                <td>${license.user_email}</td>
                                <td>${license.payment_provider}</td>
                                <td>${license.status}</td>
                                <td>${new Date(license.created_at).toLocaleString()}</td>
                                <td>${new Date(license.expires_at).toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            tableContainer.innerHTML = tableHTML;
        }

        // ë¼ì´ì„¼ìŠ¤ ì„ íƒ í† ê¸€
        function toggleLicenseSelection(licenseId) {
            if (selectedLicenses.has(licenseId)) {
                selectedLicenses.delete(licenseId);
            } else {
                selectedLicenses.add(licenseId);
            }
            updateLicenseTable();
            log(`ë¼ì´ì„¼ìŠ¤ ì„ íƒ ë³€ê²½: ${selectedLicenses.size}ê°œ ì„ íƒë¨`);
        }

        // í…ŒìŠ¤íŠ¸ ë¼ì´ì„¼ìŠ¤ ì „ì²´ ì„ íƒ
        function selectAllTestLicenses() {
            selectedLicenses.clear();
            allLicenses.forEach(license => {
                if (license.license_key.startsWith('TEST_') || license.payment_provider === 'test') {
                    selectedLicenses.add(license.id);
                }
            });
            updateLicenseTable();
            log(`í…ŒìŠ¤íŠ¸ ë¼ì´ì„¼ìŠ¤ ì „ì²´ ì„ íƒ: ${selectedLicenses.size}ê°œ`);
        }

        // ì„ íƒ í•´ì œ
        function clearSelection() {
            selectedLicenses.clear();
            updateLicenseTable();
            log('ëª¨ë“  ì„ íƒ í•´ì œë¨');
        }

        // ì„ íƒëœ ë¼ì´ì„¼ìŠ¤ ì‚­ì œ
        async function deleteSelected() {
            if (selectedLicenses.size === 0) {
                alert('ì‚­ì œí•  ë¼ì´ì„¼ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!confirm(`ì„ íƒëœ ${selectedLicenses.size}ê°œì˜ ë¼ì´ì„¼ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            try {
                log(`ì„ íƒëœ ë¼ì´ì„¼ìŠ¤ ì‚­ì œ ì‹œì‘: ${selectedLicenses.size}ê°œ`);

                const licenseIds = Array.from(selectedLicenses);

                // ê´€ë ¨ ê²°ì œ ê¸°ë¡ ë¨¼ì € ì‚­ì œ
                const { error: paymentError } = await supabase
                    .from('payments')
                    .delete()
                    .in('license_id', licenseIds);

                if (paymentError) {
                    log(`âš ï¸ ê²°ì œ ê¸°ë¡ ì‚­ì œ ì‹¤íŒ¨: ${paymentError.message}`);
                }

                // ê´€ë ¨ í™œì„±í™” ê¸°ë¡ ì‚­ì œ
                const { error: activationError } = await supabase
                    .from('user_activations')
                    .delete()
                    .in('license_id', licenseIds);

                if (activationError) {
                    log(`âš ï¸ í™œì„±í™” ê¸°ë¡ ì‚­ì œ ì‹¤íŒ¨: ${activationError.message}`);
                }

                // ë¼ì´ì„¼ìŠ¤ ì‚­ì œ
                const { error: licenseError } = await supabase
                    .from('licenses')
                    .delete()
                    .in('id', licenseIds);

                if (licenseError) {
                    throw licenseError;
                }

                selectedLicenses.clear();
                await loadCurrentData();

                log(`âœ… ì„ íƒëœ ë¼ì´ì„¼ìŠ¤ ì‚­ì œ ì™„ë£Œ`);
                alert('ì„ íƒëœ ë¼ì´ì„¼ìŠ¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');

            } catch (error) {
                log(`âŒ ë¼ì´ì„¼ìŠ¤ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
                alert(`ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // ëª¨ë“  í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ
        async function deleteAllTestData() {
            if (!confirm('ëª¨ë“  í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (TEST_ë¡œ ì‹œì‘í•˜ê±°ë‚˜ providerê°€ testì¸ ë°ì´í„°)')) {
                return;
            }

            try {
                log('ëª¨ë“  í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ ì‹œì‘...');

                // í…ŒìŠ¤íŠ¸ ë¼ì´ì„¼ìŠ¤ ì¡°íšŒ
                const { data: testLicenses, error: queryError } = await supabase
                    .from('licenses')
                    .select('id')
                    .or('license_key.like.TEST_%,payment_provider.eq.test');

                if (queryError) throw queryError;

                if (testLicenses.length === 0) {
                    alert('ì‚­ì œí•  í…ŒìŠ¤íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const testLicenseIds = testLicenses.map(l => l.id);

                // ê´€ë ¨ ë°ì´í„° ì‚­ì œ
                await supabase.from('payments').delete().in('license_id', testLicenseIds);
                await supabase.from('user_activations').delete().in('license_id', testLicenseIds);
                
                const { error: deleteError } = await supabase
                    .from('licenses')
                    .delete()
                    .in('id', testLicenseIds);

                if (deleteError) throw deleteError;

                await loadCurrentData();
                
                log(`âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ ì™„ë£Œ: ${testLicenses.length}ê°œ`);
                alert(`${testLicenses.length}ê°œì˜ í…ŒìŠ¤íŠ¸ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);

            } catch (error) {
                log(`âŒ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
                alert(`ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // ëª¨ë“  ë¼ì´ì„¼ìŠ¤ ì‚­ì œ
        async function deleteAllLicenses() {
            if (!confirm('âš ï¸ ì •ë§ë¡œ ëª¨ë“  ë¼ì´ì„¼ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) {
                return;
            }

            if (!confirm('âš ï¸âš ï¸ ë§ˆì§€ë§‰ í™•ì¸: ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                log('ëª¨ë“  ë¼ì´ì„¼ìŠ¤ ì‚­ì œ ì‹œì‘...');

                // ëª¨ë“  í…Œì´ë¸”ì˜ ë°ì´í„° ì‚­ì œ (ìˆœì„œ ì¤‘ìš”: ì™¸ë˜í‚¤ ê´€ê³„)
                await supabase.from('user_activations').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                await supabase.from('payments').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                
                const { error } = await supabase
                    .from('licenses')
                    .delete()
                    .neq('id', '00000000-0000-0000-0000-000000000000');

                if (error) throw error;

                await loadCurrentData();
                
                log('âœ… ëª¨ë“  ë¼ì´ì„¼ìŠ¤ ì‚­ì œ ì™„ë£Œ');
                alert('ëª¨ë“  ë¼ì´ì„¼ìŠ¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');

            } catch (error) {
                log(`âŒ ì „ì²´ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
                alert(`ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            log('í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬ í˜ì´ì§€ ë¡œë“œë¨');
            loadCurrentData();
        });
    </script>
</body>
</html> 