<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ˜ë™ ë¼ì´ì„¼ìŠ¤ ë°œê¸‰ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ìˆ˜ë™ ë¼ì´ì„¼ìŠ¤ ë°œê¸‰ í…ŒìŠ¤íŠ¸</h1>
        
        <div class="test-section">
            <h3>1. ê²°ì œ ì‹œë®¬ë ˆì´ì…˜ ë° ë¼ì´ì„¼ìŠ¤ ë°œê¸‰</h3>
            <div>
                <label>ê²°ì œ ì œê³µì:</label>
                <select id="paymentProvider">
                    <option value="paypal">PayPal</option>
                    <option value="toss">Toss</option>
                    <option value="test">Test</option>
                </select>
            </div>
            <div>
                <label>ì‚¬ìš©ì ì´ë©”ì¼:</label>
                <input type="email" id="userEmail" value="test@example.com">
            </div>
            <div>
                <label>ê²°ì œ ê¸ˆì•¡:</label>
                <input type="number" id="amount" value="9.99" step="0.01">
            </div>
            <button onclick="simulatePaymentAndIssueLicense()">ê²°ì œ ì‹œë®¬ë ˆì´ì…˜ ë° ë¼ì´ì„¼ìŠ¤ ë°œê¸‰</button>
            <div id="licenseResult"></div>
        </div>

        <div class="test-section">
            <h3>2. ë¼ì´ì„¼ìŠ¤ ê²€ì¦ í…ŒìŠ¤íŠ¸</h3>
            <div>
                <label>ë¼ì´ì„¼ìŠ¤ í‚¤:</label>
                <input type="text" id="licenseKey" placeholder="ë¼ì´ì„¼ìŠ¤ í‚¤ ì…ë ¥">
            </div>
            <button onclick="validateLicense()">ë¼ì´ì„¼ìŠ¤ ê²€ì¦</button>
            <div id="validationResult"></div>
        </div>

        <div class="test-section">
            <h3>3. ì‚¬ìš©ìë³„ ë¼ì´ì„¼ìŠ¤ ì¡°íšŒ</h3>
            <div>
                <label>ì¡°íšŒí•  ì´ë©”ì¼:</label>
                <input type="email" id="queryEmail" value="test@example.com">
            </div>
            <button onclick="queryUserLicenses()">ë¼ì´ì„¼ìŠ¤ ì¡°íšŒ</button>
            <div id="queryResult"></div>
        </div>

        <div class="test-section">
            <h3>4. ì „ì²´ ë¼ì´ì„¼ìŠ¤ ëª©ë¡</h3>
            <button onclick="listAllLicenses()">ì „ì²´ ë¼ì´ì„¼ìŠ¤ ì¡°íšŒ</button>
            <div id="listResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ ì‹¤í–‰ ë¡œê·¸</h3>
            <button onclick="clearLog()">ë¡œê·¸ í´ë¦¬ì–´</button>
            <div id="logOutput" class="log"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <script>
        // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        const SUPABASE_URL = 'https://qwbhuusjpnpfwwrzpnfx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3Ymh1dXNqcG5wZnd3cnpwbmZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0OTkxNTgsImV4cCI6MjA2ODA3NTE1OH0.G2k1yy6bbnpyi2F6U7cPC1Y6LtBn2nCvfuIUHPXxb9s';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function log(message) {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            logOutput.textContent += `[${timestamp}] ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logOutput').textContent = '';
        }

        function showResult(elementId, success, message) {
            const element = document.getElementById(elementId);
            element.className = success ? 'success' : 'error';
            element.innerHTML = message;
        }

        function generateLicenseKey(provider, paymentId) {
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2, 8).toUpperCase();
            return `${provider.toUpperCase()}_${timestamp}_${random}`;
        }

        // 1. ê²°ì œ ì‹œë®¬ë ˆì´ì…˜ ë° ë¼ì´ì„¼ìŠ¤ ë°œê¸‰
        async function simulatePaymentAndIssueLicense() {
            try {
                const provider = document.getElementById('paymentProvider').value;
                const userEmail = document.getElementById('userEmail').value;
                const amount = parseFloat(document.getElementById('amount').value);

                log(`ê²°ì œ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘: ${provider}, ${userEmail}, $${amount}`);

                // ê°€ì§œ ê²°ì œ ID ìƒì„±
                const paymentId = `${provider}_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`;
                log(`ìƒì„±ëœ ê²°ì œ ID: ${paymentId}`);

                // ì¤‘ë³µ ê²°ì œ í™•ì¸
                const { data: existingLicense } = await supabase
                    .from('licenses')
                    .select('license_key')
                    .eq('payment_id', paymentId)
                    .single();

                if (existingLicense) {
                    showResult('licenseResult', false, 'ì´ë¯¸ ì²˜ë¦¬ëœ ê²°ì œì…ë‹ˆë‹¤.');
                    log('âŒ ì¤‘ë³µ ê²°ì œ ê°ì§€');
                    return;
                }

                // ë¼ì´ì„¼ìŠ¤ í‚¤ ìƒì„±
                const licenseKey = generateLicenseKey(provider, paymentId);
                log(`ìƒì„±ëœ ë¼ì´ì„¼ìŠ¤ í‚¤: ${licenseKey}`);

                // ë¼ì´ì„¼ìŠ¤ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
                const licenseData = {
                    license_key: licenseKey,
                    user_email: userEmail,
                    payment_provider: provider,
                    payment_id: paymentId,
                    status: 'active'
                };

                const { data: licenseInsert, error: licenseError } = await supabase
                    .from('licenses')
                    .insert(licenseData)
                    .select();

                if (licenseError) {
                    throw licenseError;
                }

                // ê²°ì œ ê¸°ë¡ ì €ì¥
                const paymentData = {
                    license_id: licenseInsert[0].id,
                    payment_provider: provider,
                    payment_id: paymentId,
                    amount: amount,
                    currency: 'USD',
                    status: 'completed',
                    payment_data: { simulated: true, timestamp: new Date().toISOString() },
                    verified_at: new Date().toISOString()
                };

                const { data: paymentInsert, error: paymentError } = await supabase
                    .from('payments')
                    .insert(paymentData)
                    .select();

                if (paymentError) {
                    log(`âš ï¸ ê²°ì œ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨: ${paymentError.message}`);
                }

                showResult('licenseResult', true, `
                    âœ… ë¼ì´ì„¼ìŠ¤ ë°œê¸‰ ì„±ê³µ!<br>
                    ğŸ”‘ ë¼ì´ì„¼ìŠ¤ í‚¤: <strong>${licenseKey}</strong><br>
                    ğŸ’³ ê²°ì œ ID: ${paymentId}<br>
                    ğŸ“§ ì‚¬ìš©ì: ${userEmail}<br>
                    ğŸ’° ê¸ˆì•¡: $${amount}
                `);
                log(`âœ… ë¼ì´ì„¼ìŠ¤ ë°œê¸‰ ì™„ë£Œ: ${licenseKey}`);

            } catch (error) {
                showResult('licenseResult', false, `âŒ ë¼ì´ì„¼ìŠ¤ ë°œê¸‰ ì‹¤íŒ¨: ${error.message}`);
                log(`âŒ ë¼ì´ì„¼ìŠ¤ ë°œê¸‰ ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // 2. ë¼ì´ì„¼ìŠ¤ ê²€ì¦
        async function validateLicense() {
            try {
                const licenseKey = document.getElementById('licenseKey').value.trim();
                if (!licenseKey) {
                    showResult('validationResult', false, 'ë¼ì´ì„¼ìŠ¤ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                log(`ë¼ì´ì„¼ìŠ¤ ê²€ì¦ ì‹œì‘: ${licenseKey}`);

                const { data, error } = await supabase
                    .from('licenses')
                    .select('*')
                    .eq('license_key', licenseKey)
                    .single();

                if (error) {
                    if (error.code === 'PGRST116') {
                        showResult('validationResult', false, 'âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ë¼ì´ì„¼ìŠ¤ í‚¤ì…ë‹ˆë‹¤.');
                        log('âŒ ë¼ì´ì„¼ìŠ¤ í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                    } else {
                        throw error;
                    }
                    return;
                }

                const isValid = data.status === 'active' && new Date(data.expires_at) > new Date();

                if (isValid) {
                    showResult('validationResult', true, `
                        âœ… ìœ íš¨í•œ ë¼ì´ì„¼ìŠ¤ì…ë‹ˆë‹¤!<br>
                        ğŸ“§ ì‚¬ìš©ì: ${data.user_email}<br>
                        ğŸ’³ ê²°ì œ ì œê³µì: ${data.payment_provider}<br>
                        ğŸ“… ìƒì„±ì¼: ${new Date(data.created_at).toLocaleString()}<br>
                        ğŸ“… ë§Œë£Œì¼: ${new Date(data.expires_at).toLocaleString()}
                    `);
                    log(`âœ… ë¼ì´ì„¼ìŠ¤ ê²€ì¦ ì„±ê³µ: ${data.user_email}`);
                } else {
                    showResult('validationResult', false, `
                        âŒ ë§Œë£Œë˜ê±°ë‚˜ ë¹„í™œì„±í™”ëœ ë¼ì´ì„¼ìŠ¤ì…ë‹ˆë‹¤.<br>
                        ìƒíƒœ: ${data.status}<br>
                        ë§Œë£Œì¼: ${new Date(data.expires_at).toLocaleString()}
                    `);
                    log(`âŒ ë¼ì´ì„¼ìŠ¤ ë§Œë£Œ ë˜ëŠ” ë¹„í™œì„±: ${data.status}`);
                }

            } catch (error) {
                showResult('validationResult', false, `âŒ ê²€ì¦ ì¤‘ ì˜¤ë¥˜: ${error.message}`);
                log(`âŒ ë¼ì´ì„¼ìŠ¤ ê²€ì¦ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // 3. ì‚¬ìš©ìë³„ ë¼ì´ì„¼ìŠ¤ ì¡°íšŒ
        async function queryUserLicenses() {
            try {
                const email = document.getElementById('queryEmail').value.trim();
                if (!email) {
                    showResult('queryResult', false, 'ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                log(`ì‚¬ìš©ì ë¼ì´ì„¼ìŠ¤ ì¡°íšŒ: ${email}`);

                const { data, error } = await supabase
                    .from('licenses')
                    .select('*')
                    .eq('user_email', email)
                    .order('created_at', { ascending: false });

                if (error) {
                    throw error;
                }

                if (data.length === 0) {
                    showResult('queryResult', true, 'ğŸ“­ í•´ë‹¹ ì‚¬ìš©ìì˜ ë¼ì´ì„¼ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    log('ğŸ“­ ë¼ì´ì„¼ìŠ¤ ì—†ìŒ');
                    return;
                }

                const licenseList = data.map(license => `
                    <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        ğŸ”‘ <strong>${license.license_key}</strong><br>
                        ğŸ“Š ìƒíƒœ: ${license.status}<br>
                        ğŸ’³ ê²°ì œ: ${license.payment_provider} (${license.payment_id})<br>
                        ğŸ“… ìƒì„±: ${new Date(license.created_at).toLocaleString()}<br>
                        ğŸ“… ë§Œë£Œ: ${new Date(license.expires_at).toLocaleString()}
                    </div>
                `).join('');

                showResult('queryResult', true, `
                    âœ… ë¼ì´ì„¼ìŠ¤ ì¡°íšŒ ì„±ê³µ! (ì´ ${data.length}ê°œ)<br>
                    ${licenseList}
                `);
                log(`âœ… ë¼ì´ì„¼ìŠ¤ ì¡°íšŒ ì„±ê³µ: ${data.length}ê°œ ë°œê²¬`);

            } catch (error) {
                showResult('queryResult', false, `âŒ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜: ${error.message}`);
                log(`âŒ ë¼ì´ì„¼ìŠ¤ ì¡°íšŒ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // 4. ì „ì²´ ë¼ì´ì„¼ìŠ¤ ëª©ë¡
        async function listAllLicenses() {
            try {
                log('ì „ì²´ ë¼ì´ì„¼ìŠ¤ ëª©ë¡ ì¡°íšŒ ì‹œì‘');

                const { data, error } = await supabase
                    .from('licenses')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) {
                    throw error;
                }

                if (data.length === 0) {
                    showResult('listResult', true, 'ğŸ“­ ë“±ë¡ëœ ë¼ì´ì„¼ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    log('ğŸ“­ ë¼ì´ì„¼ìŠ¤ ì—†ìŒ');
                    return;
                }

                const licenseList = data.map(license => `
                    <tr>
                        <td style="padding: 5px; border: 1px solid #ddd;">${license.license_key}</td>
                        <td style="padding: 5px; border: 1px solid #ddd;">${license.user_email}</td>
                        <td style="padding: 5px; border: 1px solid #ddd;">${license.payment_provider}</td>
                        <td style="padding: 5px; border: 1px solid #ddd;">${license.status}</td>
                        <td style="padding: 5px; border: 1px solid #ddd;">${new Date(license.created_at).toLocaleDateString()}</td>
                    </tr>
                `).join('');

                showResult('listResult', true, `
                    âœ… ì „ì²´ ë¼ì´ì„¼ìŠ¤ ëª©ë¡ (ìµœê·¼ 10ê°œ)<br>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 5px; border: 1px solid #ddd;">ë¼ì´ì„¼ìŠ¤ í‚¤</th>
                            <th style="padding: 5px; border: 1px solid #ddd;">ì‚¬ìš©ì</th>
                            <th style="padding: 5px; border: 1px solid #ddd;">ê²°ì œ</th>
                            <th style="padding: 5px; border: 1px solid #ddd;">ìƒíƒœ</th>
                            <th style="padding: 5px; border: 1px solid #ddd;">ìƒì„±ì¼</th>
                        </tr>
                        ${licenseList}
                    </table>
                `);
                log(`âœ… ì „ì²´ ë¼ì´ì„¼ìŠ¤ ì¡°íšŒ ì„±ê³µ: ${data.length}ê°œ`);

            } catch (error) {
                showResult('listResult', false, `âŒ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜: ${error.message}`);
                log(`âŒ ì „ì²´ ë¼ì´ì„¼ìŠ¤ ì¡°íšŒ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            log('ìˆ˜ë™ ë¼ì´ì„¼ìŠ¤ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œë¨');
            log(`Supabase URL: ${SUPABASE_URL}`);
        });
    </script>
</body>
</html> 